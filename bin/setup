#!/usr/bin/env ruby

require 'pathname'
require 'fileutils'

include FileUtils

APP_ROOT = Pathname.new File.expand_path('../../', __FILE__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

chdir APP_ROOT do
  puts '== Installing gem dependencies =='
  system 'bundle check' or system! 'bundle install'

  puts "\n== Installing front-end dependencies =="
  chdir APP_ROOT.join('app', 'assets', 'gulp') do
    system 'yarn check &> /dev/null' or system! 'yarn install'
  end

  puts "\n== Preparing database =="
  system! 'bin/rails db:setup > /dev/null'

  puts "\n== Creating Elasticsearch indexes =="
  system 'rails r', <<-EOC
  Rails.root.join('app', 'indexes')
    .entries.reject(&:directory?)
    .map { |e| e.basename('.rb').to_s.split('_').first.capitalize.constantize }
    .each { |m| m.__elasticsearch__.create_index! }
  EOC

  puts "\n== Removing old logs and tempfiles =="
  system! 'bin/rails log:clear tmp:clear'

  puts "\n== Done. =="
end
